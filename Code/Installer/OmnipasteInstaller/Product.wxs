<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <?include $(sys.CURRENTDIR)Includes\OmnipasteVariables.wxi ?>
  
	<Product Id="*" Name="$(var.ProductName) $(var.VersionNumber)" Language="!(loc.LANG)" Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerName)" UpgradeCode="$(var.UpgradeCode)">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perUser" />

    <MediaTemplate EmbedCab="yes" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of Omnipaste is already installed." />

    <Property Id="DOTNETVERSION45FULL" Secure="yes">
      <RegistrySearch Id="DotNet45Full" Root="HKLM" Key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" Name="Version" Type="raw" />
    </Property>
    <Condition Message="!(loc.DotNetFrameworkMissing)">DOTNETVERSION45FULL&gt;="#1"</Condition>

    <Icon Id="Icon.ico" SourceFile="$(var.ResourcesDir)\Icon.ico" />
    <Property Id="ARPPRODUCTICON" Value="Icon.ico" />
    
    <Property Id="ALLUSERS" Secure="yes" Value="2"/>
    <Property Id="MSIINSTALLPERUSER" Secure="yes" Value="1" />

    <Property Id='INSTALLFOLDER'>
      <RegistrySearch Id='InstallLocationKey' Root='HKCU'
                      Key='$(var.RegistryRootKey)'
                      Name='InstallLocation' Type='raw'/>
    </Property>

    <util:CloseApplication Id="CloseApplication"
                       Target="$(var.ExeProcessName)"
                       EndSessionMessage="yes"
                       RebootPrompt="no"/>

    <Feature Id="ProductFeature" Title="$(var.ProductName)" Level="1">
      <ComponentGroupRef Id="OmnipasteFiles" />
      <ComponentRef Id="ApplicationShortcuts"/>
      <ComponentRef Id="ApplicationStartupEntry"/>
      <ComponentRef Id="CleanupMainApplicationFolder"/>
    </Feature>
    
    <InstallExecuteSequence>
      <Custom Action="WixCloseApplications" Before="InstallInitialize"/>
      <Custom Action="AssignCustomActionDataForBootstrap" After="CostFinalize"/>
      <Custom Action="AssignCustomActionDataForUnistallClickOnce" After="CostFinalize"/>
      <Custom Action="StartAppWithAuthorizationKey" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="UninstallClickOnce" Before="InstallFinalize">NOT Installed</Custom>
    </InstallExecuteSequence>
	</Product>
</Wix>