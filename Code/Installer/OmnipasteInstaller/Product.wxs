<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?include $(sys.CURRENTDIR)Includes\OmnipasteVariables.wxi ?>
  
	<Product Id="*" Name="!(loc.ProductName) $(var.VersionNumber)" Language="!(loc.LANG)" Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerName)" UpgradeCode="$(var.UpgradeCode)">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perUser" />

    <MediaTemplate EmbedCab="yes" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of Omnipaste is already installed." />

    <Property Id="DOTNETVERSION45FULL" Secure="yes">
      <RegistrySearch Id="DotNet45Full" Root="HKLM" Key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" Name="Version" Type="raw" />
    </Property>
    <Condition Message="!(loc.DotNetFrameworkMissing)">DOTNETVERSION45FULL&gt;="#1"</Condition>

    <Icon Id="Icon.ico" SourceFile="$(var.ResourcesDir)\Icon.ico" />
    <Property Id="ARPPRODUCTICON" Value="Icon.ico" />
    
    <Property Id="ALLUSERS" Secure="yes" Value="2"/>
    <Property Id="MSIINSTALLPERUSER" Secure="yes" Value="1" />

    <Property Id='INSTALLFOLDER'>
      <RegistrySearch Id='InstallLocationKey' Root='HKCU'
                      Key='$(var.RegistryRootKey)'
                      Name='InstallLocation' Type='raw'/>
    </Property>

    <Feature Id="ProductFeature" Title="!(loc.ProductName)" Level="1">
      <ComponentGroupRef Id="OmnipasteFiles" />
      <ComponentRef Id="CleanupMainApplicationFolder"/>
    </Feature>
    
    <InstallExecuteSequence>
      <Custom Action="AssignCustomActionData" After="CostFinalize"/>
      <Custom Action="StartAppWithAuthorizationKey" After="InstallFiles">NOT Installed</Custom>
    </InstallExecuteSequence>
	</Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!--Although this is set to program files folder because of previously setting the ALLUSERS and MSIINSTALLPERUSER properties, this will point to AppData-->
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="!(loc.ProductName)" />
      </Directory>
    </Directory>
  </Fragment>
</Wix>